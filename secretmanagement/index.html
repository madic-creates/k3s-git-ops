<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="A mono repository for my home Kubernetes cluster which tries to adhere to Infrastructure as Code (IaC) and GitOps practices"><meta name=author content="Michael Neese"><link href="https://madic-creates.github.io/git-ops/secretmanagement/" rel="canonical"><link href=../reflector/ rel=prev><link href=../storage/ rel=next><link rel=icon href=../assets/images/favicon.png><meta name=generator content="mkdocs-1.6.1, mkdocs-material-9.6.22"><title>Secret Management - Madic | Home GitOps</title><link rel=stylesheet href=../assets/stylesheets/main.84d31ad4.min.css><link rel="stylesheet" href="../assets/external/fonts.googleapis.com/css.49ea35f2.css"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=../extra.css><script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script><meta property=og:type content=website><meta property=og:title content="Secret Management - Madic | Home GitOps"><meta property=og:description content="A mono repository for my home Kubernetes cluster which tries to adhere to Infrastructure as Code (IaC) and GitOps practices"><meta property=og:image content=https://madic-creates.github.io/git-ops/assets/images/social/secretmanagement.png><meta property=og:image:type content=image/png><meta property=og:image:width content=1200><meta property=og:image:height content=630><meta content=https://madic-creates.github.io/git-ops/secretmanagement/ property=og:url><meta name=twitter:card content=summary_large_image><meta name=twitter:title content="Secret Management - Madic | Home GitOps"><meta name=twitter:description content="A mono repository for my home Kubernetes cluster which tries to adhere to Infrastructure as Code (IaC) and GitOps practices"><meta name=twitter:image content=https://madic-creates.github.io/git-ops/assets/images/social/secretmanagement.png></head> <body dir=ltr> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#secret-management class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class="md-header md-header--shadow" data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=.. title="Madic | Home GitOps" class="md-header__button md-logo" aria-label="Madic | Home GitOps" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> Madic | Home GitOps </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Secret Management </span> </div> </div> </div> <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </label> <nav class=md-search__options aria-label=Search> <a href=javascript:void(0) class="md-search__icon md-icon" title=Share aria-label=Share data-clipboard data-clipboard-text data-md-component=search-share tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg> </a> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap tabindex=0 data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href="https://github.com/madic-creates/k3s-git-ops" title="Go to repository" class="md-source" data-md-component="source"> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M202.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1M496 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2m-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3m-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1"/></svg> </div> <div class=md-source__repository> madic-creates/k3s-git-ops </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=.. title="Madic | Home GitOps" class="md-nav__button md-logo" aria-label="Madic | Home GitOps" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg> </a> Madic | Home GitOps </label> <div class=md-nav__source> <a href="https://github.com/madic-creates/k3s-git-ops" title="Go to repository" class="md-source" data-md-component="source"> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M202.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1M496 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2m-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3m-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1"/></svg> </div> <div class=md-source__repository> madic-creates/k3s-git-ops </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=.. class=md-nav__link> <span class=md-ellipsis> Introduction </span> </a> </li> <li class=md-nav__item> <a href=../install/ class=md-nav__link> <span class=md-ellipsis> Installation </span> </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3 checked> <label class=md-nav__link for=__nav_3 id=__nav_3_label tabindex> <span class=md-ellipsis> Applications </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_3_label aria-expanded=true> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> Applications </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../argocd/ class=md-nav__link> <span class=md-ellipsis> Argo-CD </span> </a> </li> <li class=md-nav__item> <a href=../auth/ class=md-nav__link> <span class=md-ellipsis> Authentication </span> </a> </li> <li class=md-nav__item> <a href=../backup/ class=md-nav__link> <span class=md-ellipsis> Backup </span> </a> </li> <li class=md-nav__item> <a href=../certmanager/ class=md-nav__link> <span class=md-ellipsis> Cert-Manager </span> </a> </li> <li class=md-nav__item> <a href=../databases/ class=md-nav__link> <span class=md-ellipsis> Databases </span> </a> </li> <li class=md-nav__item> <a href=../kubedoom/ class=md-nav__link> <span class=md-ellipsis> Kube DOOM </span> </a> </li> <li class=md-nav__item> <a href=../network/ class=md-nav__link> <span class=md-ellipsis> Network </span> </a> </li> <li class=md-nav__item> <a href=../loadbalancer/ class=md-nav__link> <span class=md-ellipsis> LoadBalancer </span> </a> </li> <li class=md-nav__item> <a href=../monitoring/ class=md-nav__link> <span class=md-ellipsis> Monitoring </span> </a> </li> <li class=md-nav__item> <a href=../reflector/ class=md-nav__link> <span class=md-ellipsis> Reflector </span> </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> <span class=md-ellipsis> Secret Management </span> <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> <span class=md-ellipsis> Secret Management </span> </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#requirements class=md-nav__link> <span class=md-ellipsis> Requirements </span> </a> </li> <li class=md-nav__item> <a href=#preparation class=md-nav__link> <span class=md-ellipsis> Preparation </span> </a> </li> <li class=md-nav__item> <a href=#repository-configuration class=md-nav__link> <span class=md-ellipsis> Repository configuration </span> </a> </li> <li class=md-nav__item> <a href=#kubernetes-secrets-manifests-via-ksops class=md-nav__link> <span class=md-ellipsis> Kubernetes Secrets / Manifests via KSOPS </span> </a> <nav class=md-nav aria-label="Kubernetes Secrets / Manifests via KSOPS"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#adjusting-kustomize-configuration class=md-nav__link> <span class=md-ellipsis> Adjusting kustomize configuration </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#kustomize-managed-helm-values class=md-nav__link> <span class=md-ellipsis> Kustomize managed Helm values </span> </a> <nav class=md-nav aria-label="Kustomize managed Helm values"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#configuration-of-the-configmanagementplugin class=md-nav__link> <span class=md-ellipsis> Configuration of the ConfigManagementPlugin </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#en-and-decrypting-helm-values-and-manifests class=md-nav__link> <span class=md-ellipsis> En- and decrypting helm values and manifests </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../storage/ class=md-nav__link> <span class=md-ellipsis> Storage </span> </a> </li> <li class=md-nav__item> <a href=../updates/ class=md-nav__link> <span class=md-ellipsis> Updates </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4> <label class=md-nav__link for=__nav_4 id=__nav_4_label tabindex> <span class=md-ellipsis> Operations </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_4_label aria-expanded=false> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> Operations </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../operations/longhorn-maintenance/ class=md-nav__link> <span class=md-ellipsis> Longhorn Maintenance </span> </a> </li> <li class=md-nav__item> <a href=../operations/cilium-migration/ class=md-nav__link> <span class=md-ellipsis> Migration to Cilium </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5> <label class=md-nav__link for=__nav_5 id=__nav_5_label tabindex> <span class=md-ellipsis> Tools </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_5_label aria-expanded=false> <label class=md-nav__title for=__nav_5> <span class="md-nav__icon md-icon"></span> Tools </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../helm/ class=md-nav__link> <span class=md-ellipsis> Helm </span> </a> </li> <li class=md-nav__item> <a href=../secrets/ class=md-nav__link> <span class=md-ellipsis> Secrets </span> </a> </li> <li class=md-nav__item> <a href=../mkdocs/ class=md-nav__link> <span class=md-ellipsis> MKDocs </span> </a> </li> <li class=md-nav__item> <a href=../pre-commit-hooks/ class=md-nav__link> <span class=md-ellipsis> Pre-Commit-Hooks </span> </a> </li> <li class=md-nav__item> <a href=../testenv/ class=md-nav__link> <span class=md-ellipsis> Test Environment </span> </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#requirements class=md-nav__link> <span class=md-ellipsis> Requirements </span> </a> </li> <li class=md-nav__item> <a href=#preparation class=md-nav__link> <span class=md-ellipsis> Preparation </span> </a> </li> <li class=md-nav__item> <a href=#repository-configuration class=md-nav__link> <span class=md-ellipsis> Repository configuration </span> </a> </li> <li class=md-nav__item> <a href=#kubernetes-secrets-manifests-via-ksops class=md-nav__link> <span class=md-ellipsis> Kubernetes Secrets / Manifests via KSOPS </span> </a> <nav class=md-nav aria-label="Kubernetes Secrets / Manifests via KSOPS"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#adjusting-kustomize-configuration class=md-nav__link> <span class=md-ellipsis> Adjusting kustomize configuration </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#kustomize-managed-helm-values class=md-nav__link> <span class=md-ellipsis> Kustomize managed Helm values </span> </a> <nav class=md-nav aria-label="Kustomize managed Helm values"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#configuration-of-the-configmanagementplugin class=md-nav__link> <span class=md-ellipsis> Configuration of the ConfigManagementPlugin </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#en-and-decrypting-helm-values-and-manifests class=md-nav__link> <span class=md-ellipsis> En- and decrypting helm values and manifests </span> </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1 id=secret-management>Secret Management<a class=headerlink href=#secret-management title="Permanent link">#</a></h1> <p>In this repository I use two ways to encrypt secrets, both utilizing sops and age.</p> <ul> <li><a href=#kubernetes-secrets-manifests-via-ksops>Kubernetes Secrets / Manifests are encrypted</a> via <a href="https://github.com/viaduct-ai/kustomize-sops" target="_blank">KSOPS</a> (described in this document)</li> <li><a href=#kustomize-managed-helm-values>Kustomize managed Helm values</a> are encrypted via sops and decrypted by an ArgoCD ConfigManagementPlugin</li> </ul> <p>age is the recommended encryption tool for sops as it is more secure and easier to use than gpg.</p> <h2 id=requirements>Requirements<a class=headerlink href=#requirements title="Permanent link">#</a></h2> <ul> <li><a href="https://github.com/viaduct-ai/kustomize-sops" target="_blank">ksops</a></li> <li><a href="https://github.com/FiloSottile/age" target="_blank">age</a></li> </ul> <h2 id=preparation>Preparation<a class=headerlink href=#preparation title="Permanent link">#</a></h2> <p>For both variants we need two age keypairs. One for local use and one for ArgoCD.</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-0-1>1</a></span>
<span class=normal><a href=#__codelineno-0-2>2</a></span>
<span class=normal><a href=#__codelineno-0-3>3</a></span>
<span class=normal><a href=#__codelineno-0-4>4</a></span>
<span class=normal><a href=#__codelineno-0-5>5</a></span>
<span class=normal><a href=#__codelineno-0-6>6</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-0-1 name=__codelineno-0-1></a><span class=c1># the folder for the age keypairs, consumed by sops</span>
<a id=__codelineno-0-2 name=__codelineno-0-2></a>mkdir<span class=w> </span>-p<span class=w> </span><span class=s2>&quot;</span><span class=nv>$HOME</span><span class=s2>/.config/sops/age&quot;</span>
<a id=__codelineno-0-3 name=__codelineno-0-3></a><span class=c1># local age keypair</span>
<a id=__codelineno-0-4 name=__codelineno-0-4></a>age-keygen<span class=w> </span>-o<span class=w> </span><span class=s2>&quot;</span><span class=nv>$HOME</span><span class=s2>/.config/sops/age/keys.txt&quot;</span>
<a id=__codelineno-0-5 name=__codelineno-0-5></a><span class=c1># argocd age keypair</span>
<a id=__codelineno-0-6 name=__codelineno-0-6></a>age-keygen<span class=w> </span>-o<span class=w> </span><span class=s2>&quot;</span><span class=nv>$HOME</span><span class=s2>/.config/sops/age/argo-cd.txt&quot;</span>
</code></pre></div></td></tr></table></div> <p>Example output:</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-1-1>1</a></span>
<span class=normal><a href=#__codelineno-1-2>2</a></span>
<span class=normal><a href=#__codelineno-1-3>3</a></span>
<span class=normal><a href=#__codelineno-1-4>4</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-1-1 name=__codelineno-1-1></a>cat<span class=w> </span><span class=s2>&quot;</span><span class=nv>$HOME</span><span class=s2>/.config/sops/age/keys.txt&quot;</span>
<a id=__codelineno-1-2 name=__codelineno-1-2></a><span class=c1># created: 2024-05-28T07:23:28+02:00</span>
<a id=__codelineno-1-3 name=__codelineno-1-3></a><span class=c1># public key: age***</span>
<a id=__codelineno-1-4 name=__codelineno-1-4></a>AGE-SECRET-KEY-19***
</code></pre></div></td></tr></table></div> <p>ArgoCD needs the private key of the local keypair to decrypt the secrets. So we create a kubernetes secret with the private key that ArgoCD gets mounted.</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-2-1>1</a></span>
<span class=normal><a href=#__codelineno-2-2>2</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-2-1 name=__codelineno-2-1></a>cat<span class=w> </span><span class=s2>&quot;</span><span class=nv>$HOME</span><span class=s2>/.config/sops/age/argo-cd.txt&quot;</span><span class=w> </span><span class=p>|</span><span class=w> </span>kubectl<span class=w> </span>create<span class=w> </span>secret<span class=w> </span>generic<span class=w> </span>sops-age<span class=w> </span>--namespace<span class=o>=</span>argocd<span class=w> </span><span class=se>\</span>
<a id=__codelineno-2-2 name=__codelineno-2-2></a>--from-file<span class=o>=</span>keys.txt<span class=o>=</span>/dev/stdin
</code></pre></div></td></tr></table></div> <p>Adjusted helm values to mount the sops-age secret into the argocd-server pod:</p> <div class=highlight><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>values.yaml</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-3-1> 1</a></span>
<span class=normal><a href=#__codelineno-3-2> 2</a></span>
<span class=normal><a href=#__codelineno-3-3> 3</a></span>
<span class=normal><a href=#__codelineno-3-4> 4</a></span>
<span class=normal><a href=#__codelineno-3-5> 5</a></span>
<span class=normal><a href=#__codelineno-3-6> 6</a></span>
<span class=normal><a href=#__codelineno-3-7> 7</a></span>
<span class=normal><a href=#__codelineno-3-8> 8</a></span>
<span class=normal><a href=#__codelineno-3-9> 9</a></span>
<span class=normal><a href=#__codelineno-3-10>10</a></span>
<span class=normal><a href=#__codelineno-3-11>11</a></span>
<span class=normal><a href=#__codelineno-3-12>12</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-3-1 name=__codelineno-3-1></a><span class=nt>repoServer</span><span class=p>:</span>
<a id=__codelineno-3-2 name=__codelineno-3-2></a><span class=w>  </span><span class=nt>volumes</span><span class=p>:</span>
<a id=__codelineno-3-3 name=__codelineno-3-3></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">sops-age</span>
<a id=__codelineno-3-4 name=__codelineno-3-4></a><span class=w>      </span><span class=nt>secret</span><span class=p>:</span>
<a id=__codelineno-3-5 name=__codelineno-3-5></a><span class=w>        </span><span class=nt>secretName</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">sops-age</span>
<a id=__codelineno-3-6 name=__codelineno-3-6></a><span class=w>  </span><span class=nt>volumeMounts</span><span class=p>:</span>
<a id=__codelineno-3-7 name=__codelineno-3-7></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/.config/sops/age</span>
<a id=__codelineno-3-8 name=__codelineno-3-8></a><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">sops-age</span>
<a id=__codelineno-3-9 name=__codelineno-3-9></a><span class=w>      </span><span class=nt>readOnly</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<a id=__codelineno-3-10 name=__codelineno-3-10></a><span class=w>  </span><span class=nt>env</span><span class=p>:</span>
<a id=__codelineno-3-11 name=__codelineno-3-11></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">SOPS_AGE_KEY_FILE</span>
<a id=__codelineno-3-12 name=__codelineno-3-12></a><span class=w>      </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/.config/sops/age/keys.txt</span>
</code></pre></div></td></tr></table></div> <h2 id=repository-configuration>Repository configuration<a class=headerlink href=#repository-configuration title="Permanent link">#</a></h2> <div class="admonition info"> <p class=admonition-title>Info</p> <p>The secrets need to be encrypted with both public keys. The ArgoCD key is used to decrypt the secrets in the ArgoCD cluster and the local key is used to de- and encrypt the secrets locally.</p> </div> <p>Create a <code>.sops.yaml</code> file in the repository root. Example:</p> <div class=highlight><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>.sops.yaml</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-4-1>1</a></span>
<span class=normal><a href=#__codelineno-4-2>2</a></span>
<span class=normal><a href=#__codelineno-4-3>3</a></span>
<span class=normal><a href=#__codelineno-4-4>4</a></span>
<span class=normal><a href=#__codelineno-4-5>5</a></span>
<span class=normal><a href=#__codelineno-4-6>6</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-4-1 name=__codelineno-4-1></a><span class=nt>creation_rules</span><span class=p>:</span>
<a id=__codelineno-4-2 name=__codelineno-4-2></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>path_regex</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">.*.enc.yaml</span>
<a id=__codelineno-4-3 name=__codelineno-4-3></a><span class=w>    </span><span class=nt>encrypted_regex</span><span class=p>:</span><span class=w> </span><span class=s>&quot;^(data|stringData|email|dnsNames|.*(H|h)osts?|hostname|username|password|url|issuer|clientSecret|argocdServerAdminPassword|oidc.config|commonName|literals)$&quot;</span>
<a id=__codelineno-4-4 name=__codelineno-4-4></a><span class=w>    </span><span class=nt>age</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">age1d2g7tgqpfvxulsusn3m608h60h2hne7yqwv5nh5nd24z6h0hgq0skjkhw8,age1q522xtgjrmvr43w7um5rh02ta3yfns635680hz4m7uhw0nfqj5zqgxnz27</span>
<a id=__codelineno-4-5 name=__codelineno-4-5></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>path_regex</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">secrets/argo-cd.age</span>
<a id=__codelineno-4-6 name=__codelineno-4-6></a><span class=w>    </span><span class=nt>age</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">age1d2g7tgqpfvxulsusn3m608h60h2hne7yqwv5nh5nd24z6h0hgq0skjkhw8</span>
</code></pre></div></td></tr></table></div> <p>The .sops file for this repository differs from this example.</p> <h2 id=kubernetes-secrets-manifests-via-ksops>Kubernetes Secrets / Manifests via KSOPS<a class=headerlink href=#kubernetes-secrets-manifests-via-ksops title="Permanent link">#</a></h2> <p>To use sops with ArgoCD, you need to mount ksops and the sops-age key into the argocd-server pod. The following helm values start the ksops container as an initContainer, copies the ksops and kustomize binaries into the custom-tools volume and mounts the binaries from the custom-tools volume into the repo server container. The sops-age key is also mounted into the repo server container.</p> <div class=highlight><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>values.yaml</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-5-1> 1</a></span>
<span class=normal><a href=#__codelineno-5-2> 2</a></span>
<span class=normal><a href=#__codelineno-5-3> 3</a></span>
<span class=normal><a href=#__codelineno-5-4> 4</a></span>
<span class=normal><a href=#__codelineno-5-5> 5</a></span>
<span class=normal><a href=#__codelineno-5-6> 6</a></span>
<span class=normal><a href=#__codelineno-5-7> 7</a></span>
<span class=normal><a href=#__codelineno-5-8> 8</a></span>
<span class=normal><a href=#__codelineno-5-9> 9</a></span>
<span class=normal><a href=#__codelineno-5-10>10</a></span>
<span class=normal><a href=#__codelineno-5-11>11</a></span>
<span class=normal><a href=#__codelineno-5-12>12</a></span>
<span class=normal><a href=#__codelineno-5-13>13</a></span>
<span class=normal><a href=#__codelineno-5-14>14</a></span>
<span class=normal><a href=#__codelineno-5-15>15</a></span>
<span class=normal><a href=#__codelineno-5-16>16</a></span>
<span class=normal><a href=#__codelineno-5-17>17</a></span>
<span class=normal><a href=#__codelineno-5-18>18</a></span>
<span class=normal><a href=#__codelineno-5-19>19</a></span>
<span class=normal><a href=#__codelineno-5-20>20</a></span>
<span class=normal><a href=#__codelineno-5-21>21</a></span>
<span class=normal><a href=#__codelineno-5-22>22</a></span>
<span class=normal><a href=#__codelineno-5-23>23</a></span>
<span class=normal><a href=#__codelineno-5-24>24</a></span>
<span class=normal><a href=#__codelineno-5-25>25</a></span>
<span class=normal><a href=#__codelineno-5-26>26</a></span>
<span class=normal><a href=#__codelineno-5-27>27</a></span>
<span class=normal><a href=#__codelineno-5-28>28</a></span>
<span class=normal><a href=#__codelineno-5-29>29</a></span>
<span class=normal><a href=#__codelineno-5-30>30</a></span>
<span class=normal><a href=#__codelineno-5-31>31</a></span>
<span class=normal><a href=#__codelineno-5-32>32</a></span>
<span class=normal><a href=#__codelineno-5-33>33</a></span>
<span class=normal><a href=#__codelineno-5-34>34</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-5-1 name=__codelineno-5-1></a><span class=nt>configs</span><span class=p>:</span>
<a id=__codelineno-5-2 name=__codelineno-5-2></a><span class=w>  </span><span class=nt>cm</span><span class=p>:</span>
<a id=__codelineno-5-3 name=__codelineno-5-3></a><span class=w>    </span><span class=nt>kustomize.buildOptions</span><span class=p>:</span><span class=w> </span><span class=s>&quot;--enable-helm</span><span class=nv> </span><span class=s>--enable-alpha-plugins</span><span class=nv> </span><span class=s>--enable-exec&quot;</span>
<a id=__codelineno-5-4 name=__codelineno-5-4></a><span class=nt>repoServer</span><span class=p>:</span>
<a id=__codelineno-5-5 name=__codelineno-5-5></a><span class=w>  </span><span class=c1># Use init containers to configure custom tooling</span>
<a id=__codelineno-5-6 name=__codelineno-5-6></a><span class=w>  </span><span class=c1># https://argoproj.github.io/argo-cd/operator-manual/custom_tools/</span>
<a id=__codelineno-5-7 name=__codelineno-5-7></a><span class=w>  </span><span class=nt>volumes</span><span class=p>:</span>
<a id=__codelineno-5-8 name=__codelineno-5-8></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">custom-tools</span>
<a id=__codelineno-5-9 name=__codelineno-5-9></a><span class=w>      </span><span class=nt>emptyDir</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">{}</span>
<a id=__codelineno-5-10 name=__codelineno-5-10></a><span class=w>  </span><span class=nt>initContainers</span><span class=p>:</span>
<a id=__codelineno-5-11 name=__codelineno-5-11></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">install-ksops</span>
<a id=__codelineno-5-12 name=__codelineno-5-12></a><span class=w>      </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">viaductoss/ksops:v4.3.1</span>
<a id=__codelineno-5-13 name=__codelineno-5-13></a><span class=w>      </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=s>&quot;/bin/sh&quot;</span><span class="p p-Indicator">,</span><span class=w> </span><span class=s>&quot;-c&quot;</span><span class="p p-Indicator">]</span>
<a id=__codelineno-5-14 name=__codelineno-5-14></a><span class=w>      </span><span class=nt>args</span><span class=p>:</span>
<a id=__codelineno-5-15 name=__codelineno-5-15></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;Installing KSOPS...&quot;;</span>
<a id=__codelineno-5-16 name=__codelineno-5-16></a><span class=w>          </span><span class="l l-Scalar l-Scalar-Plain">mv ksops /custom-tools/;</span>
<a id=__codelineno-5-17 name=__codelineno-5-17></a><span class=w>          </span><span class="l l-Scalar l-Scalar-Plain">mv kustomize /custom-tools/;</span>
<a id=__codelineno-5-18 name=__codelineno-5-18></a><span class=w>          </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;Done.&quot;;</span>
<a id=__codelineno-5-19 name=__codelineno-5-19></a><span class=w>      </span><span class=nt>volumeMounts</span><span class=p>:</span>
<a id=__codelineno-5-20 name=__codelineno-5-20></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/custom-tools</span>
<a id=__codelineno-5-21 name=__codelineno-5-21></a><span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">custom-tools</span>
<a id=__codelineno-5-22 name=__codelineno-5-22></a><span class=w>  </span><span class=nt>volumeMounts</span><span class=p>:</span>
<a id=__codelineno-5-23 name=__codelineno-5-23></a><span class=w>    </span><span class=c1># ksops packages it&#39;s own kustomize binary with ksops integration, overrides the argocd kustomize binary</span>
<a id=__codelineno-5-24 name=__codelineno-5-24></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/usr/local/bin/kustomize</span>
<a id=__codelineno-5-25 name=__codelineno-5-25></a><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">custom-tools</span>
<a id=__codelineno-5-26 name=__codelineno-5-26></a><span class=w>      </span><span class=nt>subPath</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">kustomize</span>
<a id=__codelineno-5-27 name=__codelineno-5-27></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/usr/local/bin/ksops</span>
<a id=__codelineno-5-28 name=__codelineno-5-28></a><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">custom-tools</span>
<a id=__codelineno-5-29 name=__codelineno-5-29></a><span class=w>      </span><span class=nt>subPath</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ksops</span>
<a id=__codelineno-5-30 name=__codelineno-5-30></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/.config/sops/age</span>
<a id=__codelineno-5-31 name=__codelineno-5-31></a><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">sops-age</span>
<a id=__codelineno-5-32 name=__codelineno-5-32></a><span class=w>  </span><span class=nt>env</span><span class=p>:</span>
<a id=__codelineno-5-33 name=__codelineno-5-33></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">XDG_CONFIG_HOME</span>
<a id=__codelineno-5-34 name=__codelineno-5-34></a><span class=w>      </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/.config</span>
</code></pre></div></td></tr></table></div> <h3 id=adjusting-kustomize-configuration>Adjusting kustomize configuration<a class=headerlink href=#adjusting-kustomize-configuration title="Permanent link">#</a></h3> <div class="admonition info"> <p class=admonition-title>Info</p> <p>To tell kustomize to use ksops for decryption, we need to add a <strong>generators</strong> configuration to the <code>kustomization.yaml</code> file.</p> </div> <div class=highlight><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>kustomization.yaml</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-6-1>1</a></span>
<span class=normal><a href=#__codelineno-6-2>2</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-6-1 name=__codelineno-6-1></a><span class=nt>generators</span><span class=p>:</span>
<a id=__codelineno-6-2 name=__codelineno-6-2></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">kustomize-secret-generator.yaml</span>
</code></pre></div></td></tr></table></div> <div class=highlight><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>kustomize-secret-generator.yaml</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-7-1> 1</a></span>
<span class=normal><a href=#__codelineno-7-2> 2</a></span>
<span class=normal><a href=#__codelineno-7-3> 3</a></span>
<span class=normal><a href=#__codelineno-7-4> 4</a></span>
<span class=normal><a href=#__codelineno-7-5> 5</a></span>
<span class=normal><a href=#__codelineno-7-6> 6</a></span>
<span class=normal><a href=#__codelineno-7-7> 7</a></span>
<span class=normal><a href=#__codelineno-7-8> 8</a></span>
<span class=normal><a href=#__codelineno-7-9> 9</a></span>
<span class=normal><a href=#__codelineno-7-10>10</a></span>
<span class=normal><a href=#__codelineno-7-11>11</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-7-1 name=__codelineno-7-1></a><span class=nn>---</span>
<a id=__codelineno-7-2 name=__codelineno-7-2></a><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">viaduct.ai/v1</span>
<a id=__codelineno-7-3 name=__codelineno-7-3></a><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ksops</span>
<a id=__codelineno-7-4 name=__codelineno-7-4></a><span class=nt>metadata</span><span class=p>:</span>
<a id=__codelineno-7-5 name=__codelineno-7-5></a><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">secret-generator</span>
<a id=__codelineno-7-6 name=__codelineno-7-6></a><span class=w>  </span><span class=nt>annotations</span><span class=p>:</span>
<a id=__codelineno-7-7 name=__codelineno-7-7></a><span class=w>    </span><span class=nt>config.kubernetes.io/function</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">|</span>
<a id=__codelineno-7-8 name=__codelineno-7-8></a><span class=w>      </span><span class=no>exec:</span>
<a id=__codelineno-7-9 name=__codelineno-7-9></a><span class=w>        </span><span class=no>path: ksops</span>
<a id=__codelineno-7-10 name=__codelineno-7-10></a><span class=nt>files</span><span class=p>:</span>
<a id=__codelineno-7-11 name=__codelineno-7-11></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">backup-secrets.enc.yaml</span>
</code></pre></div></td></tr></table></div> <p>The <strong>backup-secrets.enc.yaml</strong> is just a normal kubernetes manifest but with sops encrypted values: <a href="https://github.com/madic-creates/k3s-git-ops/blob/main/apps/emby/backup-secrets.enc.yaml" target="_blank">Example emby backup-secrets.enc.yaml</a>. Do not add thouse manifests to the resource list of the kustomization.yaml because this would result in a duplicate resource error.</p> <h2 id=kustomize-managed-helm-values>Kustomize managed Helm values<a class=headerlink href=#kustomize-managed-helm-values title="Permanent link">#</a></h2> <p>This repository makes heavy use of kustomize rendering helm charts. Kustomize can manage helm values either directly in the kustomization.yaml or in a separate file. The helm values can contain sensitive values and it's not possible to encrypt values in the kustomization.yaml file directly so we need to use a separate helm values file.</p> <div class="admonition info"> <p class=admonition-title>Info</p> <p>The workflow basically is to create an encrypted <strong>values.enc.yaml</strong>, tell kustomize to get the helm values from <strong>values.yaml</strong> and use an ArgoCD ConfigManagementPlugin to decrypt the <strong>values.enc.yaml</strong> to values.yaml. The ConfigManagementPlugin gets executed when ArgoCD finds a values.enc.yaml before kustomize renders the kubernetes manifests.</p> </div> <h3 id=configuration-of-the-configmanagementplugin>Configuration of the ConfigManagementPlugin<a class=headerlink href=#configuration-of-the-configmanagementplugin title="Permanent link">#</a></h3> <p>If ArgoCD finds a values.enc.yaml in an application directory, argo-cd runs the CMP cmp-sops-decrypt, which decryptes the file to values.yaml, and then runs kustomize.</p> <p>The ConfigManagementPlugin is configured as a configmap within a separate <a href="https://github.com/madic-creates/k3s-git-ops/tree/main/apps/argo-cd-configmanagementplugins" target="_blank">argo-cd app deployment</a>. Additionaly it needs helm and sops binaries for the argo-cd repo-server which get configured via a sidecar container. So the deployment of it needs to be extended.</p> <p>ConfigManagementPlugin:</p> <div class=highlight><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>argocd-cmp-sops-plugin.yaml</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-8-1> 1</a></span>
<span class=normal><a href=#__codelineno-8-2> 2</a></span>
<span class=normal><a href=#__codelineno-8-3> 3</a></span>
<span class=normal><a href=#__codelineno-8-4> 4</a></span>
<span class=normal><a href=#__codelineno-8-5> 5</a></span>
<span class=normal><a href=#__codelineno-8-6> 6</a></span>
<span class=normal><a href=#__codelineno-8-7> 7</a></span>
<span class=normal><a href=#__codelineno-8-8> 8</a></span>
<span class=normal><a href=#__codelineno-8-9> 9</a></span>
<span class=normal><a href=#__codelineno-8-10>10</a></span>
<span class=normal><a href=#__codelineno-8-11>11</a></span>
<span class=normal><a href=#__codelineno-8-12>12</a></span>
<span class=normal><a href=#__codelineno-8-13>13</a></span>
<span class=normal><a href=#__codelineno-8-14>14</a></span>
<span class=normal><a href=#__codelineno-8-15>15</a></span>
<span class=normal><a href=#__codelineno-8-16>16</a></span>
<span class=normal><a href=#__codelineno-8-17>17</a></span>
<span class=normal><a href=#__codelineno-8-18>18</a></span>
<span class=normal><a href=#__codelineno-8-19>19</a></span>
<span class=normal><a href=#__codelineno-8-20>20</a></span>
<span class=normal><a href=#__codelineno-8-21>21</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-8-1 name=__codelineno-8-1></a><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<a id=__codelineno-8-2 name=__codelineno-8-2></a><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ConfigMap</span>
<a id=__codelineno-8-3 name=__codelineno-8-3></a><span class=nt>metadata</span><span class=p>:</span>
<a id=__codelineno-8-4 name=__codelineno-8-4></a><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">argocd-cmp-sops-plugin</span>
<a id=__codelineno-8-5 name=__codelineno-8-5></a><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">argocd</span>
<a id=__codelineno-8-6 name=__codelineno-8-6></a><span class=nt>data</span><span class=p>:</span>
<a id=__codelineno-8-7 name=__codelineno-8-7></a><span class=w>  </span><span class=nt>plugin.yaml</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">|</span>
<a id=__codelineno-8-8 name=__codelineno-8-8></a><span class=w>    </span><span class=no>---</span>
<a id=__codelineno-8-9 name=__codelineno-8-9></a><span class=w>    </span><span class=no>apiVersion: argoproj.io/v1alpha1</span>
<a id=__codelineno-8-10 name=__codelineno-8-10></a><span class=w>    </span><span class=no>kind: ConfigManagementPlugin</span>
<a id=__codelineno-8-11 name=__codelineno-8-11></a><span class=w>    </span><span class=no>metadata:</span>
<a id=__codelineno-8-12 name=__codelineno-8-12></a><span class=w>      </span><span class=no>name: cmp-sops-decrypt</span>
<a id=__codelineno-8-13 name=__codelineno-8-13></a><span class=w>    </span><span class=no>spec:</span>
<a id=__codelineno-8-14 name=__codelineno-8-14></a><span class=w>      </span><span class=no>version: v1.0</span>
<a id=__codelineno-8-15 name=__codelineno-8-15></a><span class=w>      </span><span class=no>generate:</span>
<a id=__codelineno-8-16 name=__codelineno-8-16></a><span class=w>        </span><span class=no>command: [sh, -c]</span>
<a id=__codelineno-8-17 name=__codelineno-8-17></a><span class=w>        </span><span class=no>args:</span>
<a id=__codelineno-8-18 name=__codelineno-8-18></a><span class=w>          </span><span class=no>- sops --decrypt --input-type yaml --output-type yaml values.enc.yaml &gt; values.yaml;</span>
<a id=__codelineno-8-19 name=__codelineno-8-19></a><span class=w>            </span><span class=no>kustomize build --enable-helm --enable-alpha-plugins --enable-exec .</span>
<a id=__codelineno-8-20 name=__codelineno-8-20></a><span class=w>      </span><span class=no>discover:</span>
<a id=__codelineno-8-21 name=__codelineno-8-21></a><span class=w>        </span><span class=no>fileName: &quot;values.enc.yaml&quot;</span>
</code></pre></div></td></tr></table></div> <p>The adjusted helm values for the argo-cd repo-server. Some of the adjustments are dependent on changes from the previous section (like ksops and kustomize usage).</p> <div class=highlight><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>values.yaml</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-9-1> 1</a></span>
<span class=normal><a href=#__codelineno-9-2> 2</a></span>
<span class=normal><a href=#__codelineno-9-3> 3</a></span>
<span class=normal><a href=#__codelineno-9-4> 4</a></span>
<span class=normal><a href=#__codelineno-9-5> 5</a></span>
<span class=normal><a href=#__codelineno-9-6> 6</a></span>
<span class=normal><a href=#__codelineno-9-7> 7</a></span>
<span class=normal><a href=#__codelineno-9-8> 8</a></span>
<span class=normal><a href=#__codelineno-9-9> 9</a></span>
<span class=normal><a href=#__codelineno-9-10>10</a></span>
<span class=normal><a href=#__codelineno-9-11>11</a></span>
<span class=normal><a href=#__codelineno-9-12>12</a></span>
<span class=normal><a href=#__codelineno-9-13>13</a></span>
<span class=normal><a href=#__codelineno-9-14>14</a></span>
<span class=normal><a href=#__codelineno-9-15>15</a></span>
<span class=normal><a href=#__codelineno-9-16>16</a></span>
<span class=normal><a href=#__codelineno-9-17>17</a></span>
<span class=normal><a href=#__codelineno-9-18>18</a></span>
<span class=normal><a href=#__codelineno-9-19>19</a></span>
<span class=normal><a href=#__codelineno-9-20>20</a></span>
<span class=normal><a href=#__codelineno-9-21>21</a></span>
<span class=normal><a href=#__codelineno-9-22>22</a></span>
<span class=normal><a href=#__codelineno-9-23>23</a></span>
<span class=normal><a href=#__codelineno-9-24>24</a></span>
<span class=normal><a href=#__codelineno-9-25>25</a></span>
<span class=normal><a href=#__codelineno-9-26>26</a></span>
<span class=normal><a href=#__codelineno-9-27>27</a></span>
<span class=normal><a href=#__codelineno-9-28>28</a></span>
<span class=normal><a href=#__codelineno-9-29>29</a></span>
<span class=normal><a href=#__codelineno-9-30>30</a></span>
<span class=normal><a href=#__codelineno-9-31>31</a></span>
<span class=normal><a href=#__codelineno-9-32>32</a></span>
<span class=normal><a href=#__codelineno-9-33>33</a></span>
<span class=normal><a href=#__codelineno-9-34>34</a></span>
<span class=normal><a href=#__codelineno-9-35>35</a></span>
<span class=normal><a href=#__codelineno-9-36>36</a></span>
<span class=normal><a href=#__codelineno-9-37>37</a></span>
<span class=normal><a href=#__codelineno-9-38>38</a></span>
<span class=normal><a href=#__codelineno-9-39>39</a></span>
<span class=normal><a href=#__codelineno-9-40>40</a></span>
<span class=normal><a href=#__codelineno-9-41>41</a></span>
<span class=normal><a href=#__codelineno-9-42>42</a></span>
<span class=normal><a href=#__codelineno-9-43>43</a></span>
<span class=normal><a href=#__codelineno-9-44>44</a></span>
<span class=normal><a href=#__codelineno-9-45>45</a></span>
<span class=normal><a href=#__codelineno-9-46>46</a></span>
<span class=normal><a href=#__codelineno-9-47>47</a></span>
<span class=normal><a href=#__codelineno-9-48>48</a></span>
<span class=normal><a href=#__codelineno-9-49>49</a></span>
<span class=normal><a href=#__codelineno-9-50>50</a></span>
<span class=normal><a href=#__codelineno-9-51>51</a></span>
<span class=normal><a href=#__codelineno-9-52>52</a></span>
<span class=normal><a href=#__codelineno-9-53>53</a></span>
<span class=normal><a href=#__codelineno-9-54>54</a></span>
<span class=normal><a href=#__codelineno-9-55>55</a></span>
<span class=normal><a href=#__codelineno-9-56>56</a></span>
<span class=normal><a href=#__codelineno-9-57>57</a></span>
<span class=normal><a href=#__codelineno-9-58>58</a></span>
<span class=normal><a href=#__codelineno-9-59>59</a></span>
<span class=normal><a href=#__codelineno-9-60>60</a></span>
<span class=normal><a href=#__codelineno-9-61>61</a></span>
<span class=normal><a href=#__codelineno-9-62>62</a></span>
<span class=normal><a href=#__codelineno-9-63>63</a></span>
<span class=normal><a href=#__codelineno-9-64>64</a></span>
<span class=normal><a href=#__codelineno-9-65>65</a></span>
<span class=normal><a href=#__codelineno-9-66>66</a></span>
<span class=normal><a href=#__codelineno-9-67>67</a></span>
<span class=normal><a href=#__codelineno-9-68>68</a></span>
<span class=normal><a href=#__codelineno-9-69>69</a></span>
<span class=normal><a href=#__codelineno-9-70>70</a></span>
<span class=normal><a href=#__codelineno-9-71>71</a></span>
<span class=normal><a href=#__codelineno-9-72>72</a></span>
<span class=normal><a href=#__codelineno-9-73>73</a></span>
<span class=normal><a href=#__codelineno-9-74>74</a></span>
<span class=normal><a href=#__codelineno-9-75>75</a></span>
<span class=normal><a href=#__codelineno-9-76>76</a></span>
<span class=normal><a href=#__codelineno-9-77>77</a></span>
<span class=normal><a href=#__codelineno-9-78>78</a></span>
<span class=normal><a href=#__codelineno-9-79>79</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-9-1 name=__codelineno-9-1></a><span class=nt>repoServer</span><span class=p>:</span>
<a id=__codelineno-9-2 name=__codelineno-9-2></a><span class=w>  </span><span class=c1># Addingcustom tools volume and ConfigManagementPlugin to the repo-server pod deployment</span>
<a id=__codelineno-9-3 name=__codelineno-9-3></a><span class=w>  </span><span class=nt>volumes</span><span class=p>:</span>
<a id=__codelineno-9-4 name=__codelineno-9-4></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">custom-tools</span>
<a id=__codelineno-9-5 name=__codelineno-9-5></a><span class=w>      </span><span class=nt>emptyDir</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">{}</span>
<a id=__codelineno-9-6 name=__codelineno-9-6></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">cmp-tmp</span>
<a id=__codelineno-9-7 name=__codelineno-9-7></a><span class=w>      </span><span class=nt>emptyDir</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">{}</span>
<a id=__codelineno-9-8 name=__codelineno-9-8></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">cmp-sops-plugin</span>
<a id=__codelineno-9-9 name=__codelineno-9-9></a><span class=w>      </span><span class=nt>configMap</span><span class=p>:</span>
<a id=__codelineno-9-10 name=__codelineno-9-10></a><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">argocd-cmp-sops-plugin</span>
<a id=__codelineno-9-11 name=__codelineno-9-11></a><span class=w>  </span><span class=c1># Installation of binaries</span>
<a id=__codelineno-9-12 name=__codelineno-9-12></a><span class=w>  </span><span class=nt>initContainers</span><span class=p>:</span>
<a id=__codelineno-9-13 name=__codelineno-9-13></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">install-sops</span>
<a id=__codelineno-9-14 name=__codelineno-9-14></a><span class=w>      </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ghcr.io/getsops/sops:v3.8.1-alpine</span>
<a id=__codelineno-9-15 name=__codelineno-9-15></a><span class=w>      </span><span class=nt>command</span><span class=p>:</span>
<a id=__codelineno-9-16 name=__codelineno-9-16></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/bin/sh</span>
<a id=__codelineno-9-17 name=__codelineno-9-17></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">-c</span>
<a id=__codelineno-9-18 name=__codelineno-9-18></a><span class=w>      </span><span class=nt>args</span><span class=p>:</span>
<a id=__codelineno-9-19 name=__codelineno-9-19></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;Installing SOPS...&quot;;</span>
<a id=__codelineno-9-20 name=__codelineno-9-20></a><span class=w>          </span><span class="l l-Scalar l-Scalar-Plain">cp /usr/local/bin/sops /custom-tools/;</span>
<a id=__codelineno-9-21 name=__codelineno-9-21></a><span class=w>          </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;Done.&quot;;</span>
<a id=__codelineno-9-22 name=__codelineno-9-22></a><span class=w>      </span><span class=nt>volumeMounts</span><span class=p>:</span>
<a id=__codelineno-9-23 name=__codelineno-9-23></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/custom-tools</span>
<a id=__codelineno-9-24 name=__codelineno-9-24></a><span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">custom-tools</span>
<a id=__codelineno-9-25 name=__codelineno-9-25></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">install-helm</span>
<a id=__codelineno-9-26 name=__codelineno-9-26></a><span class=w>      </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">alpine/helm:3.15.1</span>
<a id=__codelineno-9-27 name=__codelineno-9-27></a><span class=w>      </span><span class=nt>command</span><span class=p>:</span>
<a id=__codelineno-9-28 name=__codelineno-9-28></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/bin/sh</span>
<a id=__codelineno-9-29 name=__codelineno-9-29></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">-c</span>
<a id=__codelineno-9-30 name=__codelineno-9-30></a><span class=w>      </span><span class=nt>args</span><span class=p>:</span>
<a id=__codelineno-9-31 name=__codelineno-9-31></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;Installing helm...&quot;; cp /usr/bin/helm /custom-tools/; echo &quot;Done.&quot;;</span>
<a id=__codelineno-9-32 name=__codelineno-9-32></a><span class=w>      </span><span class=nt>volumeMounts</span><span class=p>:</span>
<a id=__codelineno-9-33 name=__codelineno-9-33></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/custom-tools</span>
<a id=__codelineno-9-34 name=__codelineno-9-34></a><span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">custom-tools</span>
<a id=__codelineno-9-35 name=__codelineno-9-35></a><span class=w>  </span><span class=c1># Adding Container responsible for the configured ConfigManagementPlugin</span>
<a id=__codelineno-9-36 name=__codelineno-9-36></a><span class=w>  </span><span class=nt>extraContainers</span><span class=p>:</span>
<a id=__codelineno-9-37 name=__codelineno-9-37></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">cmp-sops-plugin</span>
<a id=__codelineno-9-38 name=__codelineno-9-38></a><span class=w>      </span><span class=nt>command</span><span class=p>:</span>
<a id=__codelineno-9-39 name=__codelineno-9-39></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class=s>&quot;/var/run/argocd/argocd-cmp-server&quot;</span>
<a id=__codelineno-9-40 name=__codelineno-9-40></a><span class=w>      </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">alpine:3.20.0</span>
<a id=__codelineno-9-41 name=__codelineno-9-41></a><span class=w>      </span><span class=nt>imagePullPolicy</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">IfNotPresent</span>
<a id=__codelineno-9-42 name=__codelineno-9-42></a><span class=w>      </span><span class=nt>securityContext</span><span class=p>:</span>
<a id=__codelineno-9-43 name=__codelineno-9-43></a><span class=w>        </span><span class=nt>runAsNonRoot</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<a id=__codelineno-9-44 name=__codelineno-9-44></a><span class=w>        </span><span class=nt>runAsUser</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">999</span>
<a id=__codelineno-9-45 name=__codelineno-9-45></a><span class=w>      </span><span class=nt>volumeMounts</span><span class=p>:</span>
<a id=__codelineno-9-46 name=__codelineno-9-46></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/var/run/argocd</span>
<a id=__codelineno-9-47 name=__codelineno-9-47></a><span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">var-files</span>
<a id=__codelineno-9-48 name=__codelineno-9-48></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/home/argocd/cmp-server/plugins</span>
<a id=__codelineno-9-49 name=__codelineno-9-49></a><span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">plugins</span>
<a id=__codelineno-9-50 name=__codelineno-9-50></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/home/argocd/cmp-server/config/plugin.yaml</span>
<a id=__codelineno-9-51 name=__codelineno-9-51></a><span class=w>          </span><span class=nt>subPath</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">plugin.yaml</span>
<a id=__codelineno-9-52 name=__codelineno-9-52></a><span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">cmp-sops-plugin</span>
<a id=__codelineno-9-53 name=__codelineno-9-53></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/tmp</span>
<a id=__codelineno-9-54 name=__codelineno-9-54></a><span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">cmp-tmp</span>
<a id=__codelineno-9-55 name=__codelineno-9-55></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/usr/local/bin/kustomize</span>
<a id=__codelineno-9-56 name=__codelineno-9-56></a><span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">custom-tools</span>
<a id=__codelineno-9-57 name=__codelineno-9-57></a><span class=w>          </span><span class=nt>subPath</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">kustomize</span>
<a id=__codelineno-9-58 name=__codelineno-9-58></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/usr/local/bin/ksops</span>
<a id=__codelineno-9-59 name=__codelineno-9-59></a><span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">custom-tools</span>
<a id=__codelineno-9-60 name=__codelineno-9-60></a><span class=w>          </span><span class=nt>subPath</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ksops</span>
<a id=__codelineno-9-61 name=__codelineno-9-61></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/usr/local/bin/sops</span>
<a id=__codelineno-9-62 name=__codelineno-9-62></a><span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">custom-tools</span>
<a id=__codelineno-9-63 name=__codelineno-9-63></a><span class=w>          </span><span class=nt>subPath</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">sops</span>
<a id=__codelineno-9-64 name=__codelineno-9-64></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/usr/local/bin/helm</span>
<a id=__codelineno-9-65 name=__codelineno-9-65></a><span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">custom-tools</span>
<a id=__codelineno-9-66 name=__codelineno-9-66></a><span class=w>          </span><span class=nt>subPath</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">helm</span>
<a id=__codelineno-9-67 name=__codelineno-9-67></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/.config/sops/age</span>
<a id=__codelineno-9-68 name=__codelineno-9-68></a><span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">sops-age</span>
<a id=__codelineno-9-69 name=__codelineno-9-69></a><span class=w>          </span><span class=nt>readOnly</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<a id=__codelineno-9-70 name=__codelineno-9-70></a><span class=w>  </span><span class=nt>volumeMounts</span><span class=p>:</span>
<a id=__codelineno-9-71 name=__codelineno-9-71></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/usr/local/bin/kustomize</span>
<a id=__codelineno-9-72 name=__codelineno-9-72></a><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">custom-tools</span>
<a id=__codelineno-9-73 name=__codelineno-9-73></a><span class=w>      </span><span class=nt>subPath</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">kustomize</span>
<a id=__codelineno-9-74 name=__codelineno-9-74></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/usr/local/bin/ksops</span>
<a id=__codelineno-9-75 name=__codelineno-9-75></a><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">custom-tools</span>
<a id=__codelineno-9-76 name=__codelineno-9-76></a><span class=w>      </span><span class=nt>subPath</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ksops</span>
<a id=__codelineno-9-77 name=__codelineno-9-77></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/.config/sops/age</span>
<a id=__codelineno-9-78 name=__codelineno-9-78></a><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">sops-age</span>
<a id=__codelineno-9-79 name=__codelineno-9-79></a><span class=w>      </span><span class=nt>readOnly</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</code></pre></div></td></tr></table></div> <p>This basically builds the plugin container with all required tools on-demand.</p> <p>Of course, the configuration could be way shorter if a container, that already includes the following binaries, would be used as extraContainer 🤷</p> <ul> <li>kustomize (from ksops)</li> <li>ksops</li> <li>sops</li> <li>helm</li> </ul> <p>More information about my journey to en- and decrypt values.yaml can be found in the following ksops issue on github: <a href="https://github.com/viaduct-ai/kustomize-sops/issues/242" target="_blank">Support kustomize helmCharts valuesFile</a>.</p> <h2 id=en-and-decrypting-helm-values-and-manifests>En- and decrypting helm values and manifests<a class=headerlink href=#en-and-decrypting-helm-values-and-manifests title="Permanent link">#</a></h2> <p>To encrypt a file inplace, use the following command:</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-10-1>1</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-10-1 name=__codelineno-10-1></a>sops<span class=w> </span>-e<span class=w> </span>-i<span class=w> </span>secret.enc.yaml
</code></pre></div></td></tr></table></div> <p>To decrypt a file inplace, use the following command:</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-11-1>1</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-11-1 name=__codelineno-11-1></a>sops<span class=w> </span>-d<span class=w> </span>-i<span class=w> </span>secret.enc.yaml
</code></pre></div></td></tr></table></div> <div class="admonition tip"> <p class=admonition-title>Tip</p> <p>If you're working with VSCode I can recommend the extension <a href="https://marketplace.visualstudio.com/items?itemName=signageos.signageos-vscode-sops" target="_blank">@signageos/vscode-sops</a> which automatically decrypts and encrypts secrets on save.</p> <p>It can also automatically encrypt files which are not yet encrypted. To enable this feature, add the following to your <code>settings.json</code>:</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-12-1>1</a></span>
<span class=normal><a href=#__codelineno-12-2>2</a></span>
<span class=normal><a href=#__codelineno-12-3>3</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-12-1 name=__codelineno-12-1></a><span class=p>{</span>
<a id=__codelineno-12-2 name=__codelineno-12-2></a><span class=w>  </span><span class=nt>&quot;sops.creationEnabled&quot;</span><span class=p>:</span><span class=w> </span><span class=kc>true</span>
<a id=__codelineno-12-3 name=__codelineno-12-3></a><span class=p>}</span>
</code></pre></div></td></tr></table></div> <p>This will automatically encrypt files which match the <code>creation_rules</code> in the <code>.sops.yaml</code> file.</p> </div> </article> </div> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> </main> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> Copyright &copy; 2024 </div> Made with <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener"> Material for MkDocs </a> </div> <div class=md-social> <a href="https://github.com/madic-creates" target="_blank" rel="noopener" title="github.com" class="md-social__link"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg> </a> <a href="https://chaos.social/@Madic" target="_blank" rel="noopener me" title="chaos.social" class="md-social__link"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M433 179.1c0-97.2-63.7-125.7-63.7-125.7-62.5-28.7-228.6-28.4-290.5 0 0 0-63.7 28.5-63.7 125.7 0 115.7-6.6 259.4 105.6 289.1 40.5 10.7 75.3 13 103.3 11.4 50.8-2.8 79.3-18.1 79.3-18.1l-1.7-36.9s-36.3 11.4-77.1 10.1c-40.4-1.4-83-4.4-89.6-54-.6-4.6-.9-9.3-.9-13.9 85.6 20.9 158.7 9.1 178.7 6.7 56.1-6.7 105-41.3 111.2-72.9 9.8-49.8 9-121.5 9-121.5zm-75.1 125.2h-46.6V190.1c0-49.7-64-51.6-64 6.9v62.5H201V197c0-58.5-64-56.6-64-6.9v114.2H90.3c0-122.1-5.2-147.9 18.4-175 25.9-28.9 79.8-30.8 103.8 6.1l11.6 19.5 11.6-19.5c24.1-37.1 78.1-34.8 103.8-6.1 23.7 27.3 18.4 53 18.4 175"/></svg> </a> <a href="https://www.geekbundle.org" target="_blank" rel="noopener" title="www.geekbundle.org" class="md-social__link"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="m61.7 169.4 101.5 278C92.2 413 43.3 340.2 43.3 256c0-30.9 6.6-60.1 18.4-86.6m337.9 75.9c0-26.3-9.4-44.5-17.5-58.7-10.8-17.5-20.9-32.4-20.9-49.9 0-19.6 14.8-37.8 35.7-37.8.9 0 1.8.1 2.8.2-37.9-34.7-88.3-55.9-143.7-55.9-74.3 0-139.7 38.1-177.8 95.9 5 .2 9.7.3 13.7.3 22.2 0 56.7-2.7 56.7-2.7 11.5-.7 12.8 16.2 1.4 17.5 0 0-11.5 1.3-24.3 2l77.5 230.4L249.8 247l-33.1-90.8c-11.5-.7-22.3-2-22.3-2-11.5-.7-10.1-18.2 1.3-17.5 0 0 35.1 2.7 56 2.7 22.2 0 56.7-2.7 56.7-2.7 11.5-.7 12.8 16.2 1.4 17.5 0 0-11.5 1.3-24.3 2l76.9 228.7 21.2-70.9c9-29.4 16-50.5 16-68.7m-139.9 29.3-63.8 185.5c19.1 5.6 39.2 8.7 60.1 8.7 24.8 0 48.5-4.3 70.6-12.1-.6-.9-1.1-1.9-1.5-2.9zm183-120.7c.9 6.8 1.4 14 1.4 21.9 0 21.6-4 45.8-16.2 76.2l-65 187.9C426.2 403 468.7 334.5 468.7 256c0-37-9.4-71.8-26-102.1M8 256a248 248 0 1 1 496 0 248 248 0 1 1-496 0m484.6 0a236.6 236.6 0 1 0-473.2 0 236.6 236.6 0 1 0 473.2 0"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "..", "features": ["navigation.sections", "navigation.tracking", "search.highlight", "search.share", "search.suggest", "content.code.copy"], "search": "../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script> <script src=../assets/javascripts/bundle.f55a23d4.min.js></script> </body> </html>