---
# code: language=ansible

- name: "Archlinux | Update archlinux-keyring"
  community.general.pacman:
    name:
      - archlinux-keyring
    state: latest

- name: "Archlinux | Install packages"
  community.general.pacman:
    name:
      - nano
      - htop
      - open-iscsi
      - k9s
      - nfs-utils

- name: "Archlinux | Install qemu-guest-agent on KVM"
  community.general.pacman:
    name: qemu-guest-agent
  when: ansible_virtualization_type == "kvm"

- name: "Archlinux | Comment out DNS servers from vagrant image"
  ansible.builtin.lineinfile:
    path: /etc/systemd/resolved.conf
    regexp: '^DNS=4\.2\.2\.1 4\.2\.2\.2 208\.67\.220\.220'
    line: '#DNS=4.2.2.1 4.2.2.2 208.67.220.220'
    backrefs: true
    state: present
  notify: "Restart systemd-resolved"

# MSS Clamping configuration
# Required to prevent SSH connection timeouts when using Cilium with
# WireGuard encryption and Geneve tunnels. The effective Path MTU to some
# external hosts may be lower than the configured Cilium MTU, causing
# large TCP packets to be silently dropped.
- name: "Archlinux | Deploy MSS clamping script"
  ansible.builtin.copy:
    src: mss-clamp.sh
    dest: /usr/local/bin/mss-clamp.sh
    owner: root
    group: root
    mode: '0755'

- name: "Archlinux | Deploy MSS clamping systemd service"
  ansible.builtin.template:
    src: mss-clamping.service.j2
    dest: /etc/systemd/system/mss-clamping.service
    owner: root
    group: root
    mode: '0644'
  notify: "Reload systemd daemon"

- name: "Archlinux | Enable and start MSS clamping service"
  ansible.builtin.systemd:
    name: mss-clamping
    enabled: true
    state: started
    daemon_reload: true
