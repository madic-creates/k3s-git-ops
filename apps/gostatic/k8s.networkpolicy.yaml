apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: gostatic
  namespace: media
  annotations:
    argocd.argoproj.io/sync-wave: "30"
  labels:
    app.kubernetes.io/name: gostatic
spec:
  endpointSelector:
    matchLabels:
      app.kubernetes.io/name: gostatic
  ingress:
    # Allow traffic from Cilium Gateway API
    - fromEndpoints:
        - matchLabels:
            k8s:io.cilium.gateway/owning-gateway: cilium-gateway
      toPorts:
        - ports:
            - port: "8043"
              protocol: TCP
    # Allow traffic from minecraft
    - fromEndpoints:
        - matchLabels:
            k8s:io.kubernetes.pod.namespace: minecraft
            k8s:app.kubernetes.io/name: minecraft
      toPorts:
        - ports:
            - port: "8043"
              protocol: TCP
    # Allow traffic from pihole
    - fromEndpoints:
        - matchLabels:
            k8s:io.kubernetes.pod.namespace: dns
            k8s:app.kubernetes.io/name: pihole
      toPorts:
        - ports:
            - port: "8043"
              protocol: TCP
    # Allow traffic from outside the cluster (external IPs)
    - fromEntities:
        - world
      toPorts:
        - ports:
            - port: "8043"
              protocol: TCP
  egress:
    # DNS resolution
    - toEndpoints:
        - matchLabels:
            k8s:io.kubernetes.pod.namespace: kube-system
            k8s-app: kube-dns
      toPorts:
        - ports:
            - port: "53"
              protocol: UDP
            - port: "53"
              protocol: TCP
