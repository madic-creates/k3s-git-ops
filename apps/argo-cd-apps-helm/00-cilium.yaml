---
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: 00-cilium
  namespace: argocd
  finalizers:
    - resources-finalizer.argocd.argoproj.io
  annotations:
    argocd.argoproj.io/sync-wave: "0"
spec:
  project: default
  source:
    chart: cilium
    repoURL: https://helm.cilium.io/
    targetRevision: 1.18.2
    helm:
      releaseName: cilium
      valuesObject:
        # Cilium operator config
        operator:
          replicas: 1
          # Roll out cilium-operator pods automatically when configmap is updated.
          rollOutPods: true
          # Install operator on master node
          nodeSelector:
            node-role.kubernetes.io/master: "true"
        # Roll out cilium agent pods automatically when ConfigMap is updated.
        rollOutCiliumPods: true
        # K8s API service
        k8sServiceHost: 127.0.0.1
        k8sServicePort: 6444
        # Replace Kube-proxy
        kubeProxyReplacement: true
        kubeProxyReplacementHealthzBindAddr: 0.0.0.0:10256
        # -- Configure IP Address Management mode.
        # ref: https://docs.cilium.io/en/stable/network/concepts/ipam/
        ipam:
          operator:
            clusterPoolIPv4PodCIDRList: 10.42.0.0/16
        # Configure L2 announcements (LB-IPAM configuration)
        l2announcements:
          enabled: false
        externalIPs:
          enabled: false
        devices: eno1 bond0
        # Increase the k8s api client rate limit to avoid being limited due to increased API usage
        k8sClientRateLimit:
          qps: 50
          burst: 200
        ingressController:
          enabled: false
          default: false
          loadbalancerMode: dedicated
        hubble:
          enabled: true
          relay:
            enabled: true
          ui:
            enabled: true
          # Event buffer capacity - number of recent flows to cache
          # Must be one less than a power of 2, max 65535
          # Default: 4095, Extended: 65535 for more flow history
          eventBufferCapacity: 65535
          # Event queue size - buffer for monitor events channel
          # Prevents "queue is full; dropping messages" on loaded clusters
          # If not set, uses default monitor queue size
          eventQueueSize: 10000
        # Native routing mode for L2-adjacent nodes (same subnet)
        # More efficient than tunnel mode - no Geneve encapsulation overhead
        routingMode: native
        autoDirectNodeRoutes: true
        # Configure MTU for WireGuard only (1500 - 60 bytes WireGuard overhead)
        MTU: 1440
        # WireGuard encryption for pod-to-pod traffic between nodes
        encryption:
          enabled: true
          type: wireguard
        loadBalancer:
          mode: hybrid
  destination:
    server: "https://kubernetes.default.svc"
    namespace: kube-system
  syncPolicy:
    syncOptions:
      - ApplyOutOfSyncOnly=true
    automated:
      prune: true
      selfHeal: true
---
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: 00-cilium-config
  namespace: argocd
  finalizers:
    - resources-finalizer.argocd.argoproj.io
  annotations:
    argocd.argoproj.io/sync-wave: "0"
spec:
  project: default
  source:
    repoURL: "https://github.com/madic-creates/k3s-git-ops.git"
    path: apps/cilium-config
    targetRevision: HEAD
  destination:
    server: "https://kubernetes.default.svc"
    namespace: default
  syncPolicy:
    syncOptions:
      - ApplyOutOfSyncOnly=true
    automated:
      prune: true
      selfHeal: true
#---
#apiVersion: argoproj.io/v1alpha1
#kind: Application
#metadata:
#  name: 00-cilium-network-policies
#  namespace: argocd
#  finalizers:
#    - resources-finalizer.argocd.argoproj.io
#  annotations:
#    argocd.argoproj.io/sync-wave: "0"
#spec:
#  project: default
#  source:
#    repoURL: "https://github.com/madic-creates/k3s-git-ops.git"
#    path: apps/cilium-network-policies
#    targetRevision: HEAD
#  destination:
#    server: "https://kubernetes.default.svc"
#    namespace: default
#  syncPolicy:
#    syncOptions:
#      - ApplyOutOfSyncOnly=true
#    automated:
#      prune: true
#      selfHeal: true
