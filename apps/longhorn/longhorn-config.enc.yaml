# Solving API issue.
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
    name: svc-longhorn-headers
    namespace: longhorn
spec:
    headers:
        customRequestHeaders:
            X-Forwarded-Proto: https
sops:
    age:
        - recipient: age1d2g7tgqpfvxulsusn3m608h60h2hne7yqwv5nh5nd24z6h0hgq0skjkhw8
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBLSjgzbm9DcWRMUTBSeHJG
            RG00RXcrbnZQK0wwWHFHbEJDZFlLcS9QQzNZCkc2WTNKSEh3RFRlbXRxSzZ1cWFU
            SkhlMHN0KytBOE9tUzRITXhNTk9TS1EKLS0tIEl1VG03WEoxY2pnMDVMU1lCYjUr
            RW45azlhU3VmQlZLM2QwYUFPOGg4QW8KdvJtNTyhfRNdvNKEWy/be6JoqZTRKkMA
            d+aPJrDzVDNjG2qZdHD3SQvwMbvHuKpnvh4nU7StzUBfUhavBT74GQ==
            -----END AGE ENCRYPTED FILE-----
        - recipient: age1q522xtgjrmvr43w7um5rh02ta3yfns635680hz4m7uhw0nfqj5zqgxnz27
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSByWlpubUtMdC85SVdPTGMx
            dnhxSGREV3VSN3FUY1JzcUw1eWFYNmhHaG1vCjBiWXkvZlhNbGJUZTZ0V1BZVk91
            RllvT0tMYldreC9qZ2xUc1pINjRGRkUKLS0tIFQ0T0psQWQ2ZGNLbDdWd2hwandJ
            QVVVNHFJb0I2anlHcGZmc1lVRUQ0Z2sKvYOAkSyjsu989v7Bhmy3lZzLoYyTIUYy
            6nkjVV1BGHM6u4oDyF1WD1nP1W6I89avWZS32Z1Fc5aWxi3K8BlOLQ==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2025-09-09T19:47:11Z"
    mac: ENC[AES256_GCM,data:pPSM0M+ViVpUnDVP+U45m7ZzbZ8zw5jQKthc0rhQHhhNEDrNEzIwvR02sgfZdQAIDADUH/KbVAUNJtmqRyQBxl6WuVHg62hC+Pdv3Cd3aQf3d+Wco+dkCLNzHfo2dI+9Ocn2hV7hiZ6VImKo+MMmy5gLEsWi08McdSwZ/ICOfFw=,iv:feYLSkw95o2b2gBy2v8zkv9iqufokQMpkLxQS+WNOnI=,tag:CKU2CHaAjmBcor1JOiM7LQ==,type:str]
    encrypted_regex: ^(data|stringData|email|dnsNames|.*(H|h)osts?|hostname|username|password|url|issuer|argocdServerAdminPassword|oidc.config|commonName|literals|.*awsAccessKeyId|.*awsSecretAccessKey|.*defaultAdminPassword|apiToken|accountId|rootPassword|replicationPassword|adminPassword|root_url|client_secret|auth_url|api_url|PIHOLE_DOMAIN|TUNNEL_DNS_UPSTREAM|customDnsEntries|securityTokenKey|emailRecipients|.*provider_url|.*redirect_url|.*accesskeyEncryption|SEMAPHORE_WEB_ROOT|token|cookieEncryption|cookieHash)$
    version: 3.10.2
---
# HTTPS Ingress
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
    name: longhorn
    namespace: longhorn
    annotations:
        # HTTPS as entry point
        traefik.ingress.kubernetes.io/router.entrypoints: websecure
        # Enable TLS
        traefik.ingress.kubernetes.io/router.tls: "true"
        # Use Basic Auth Midleware configured
        traefik.ingress.kubernetes.io/router.middlewares: longhorn-svc-longhorn-headers@kubernetescrd, authelia-forwardauth-authelia@kubernetescrd
        # Enable cert-manager to create automatically the SSL certificate and store in Secret
        #cert-manager.io/cluster-issuer: netcup-issuer-staging
        #cert-manager.io/cluster-issuer: ca-issuer
spec:
    tls:
        - hosts:
            - ENC[AES256_GCM,data:HpomtCTxtXk6z60B3sYuc+vx+q+wAysS,iv:0MIUSFKQ7Co8cnMj/6ezxSAosmW8bMHOy4qSCBVLIFY=,tag:3MSpBLcwM73tmSV31Z6rUg==,type:str]
          secretName: wildcard-cloudflare-production-01
    rules:
        - host: ENC[AES256_GCM,data:hvLSvkQbqKhXINnIc8pchQskLz3U0FDC,iv:KC/Nd22lupfTCKgZS3gN8XRJA33/Chg1vgDr26/5xdo=,tag:s+ZhTqnKTObkNfZDo7UZcw==,type:str]
          http:
            paths:
                - path: /
                  pathType: Prefix
                  backend:
                    service:
                        name: longhorn-frontend
                        port:
                            number: 80
sops:
    age:
        - recipient: age1d2g7tgqpfvxulsusn3m608h60h2hne7yqwv5nh5nd24z6h0hgq0skjkhw8
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBLSjgzbm9DcWRMUTBSeHJG
            RG00RXcrbnZQK0wwWHFHbEJDZFlLcS9QQzNZCkc2WTNKSEh3RFRlbXRxSzZ1cWFU
            SkhlMHN0KytBOE9tUzRITXhNTk9TS1EKLS0tIEl1VG03WEoxY2pnMDVMU1lCYjUr
            RW45azlhU3VmQlZLM2QwYUFPOGg4QW8KdvJtNTyhfRNdvNKEWy/be6JoqZTRKkMA
            d+aPJrDzVDNjG2qZdHD3SQvwMbvHuKpnvh4nU7StzUBfUhavBT74GQ==
            -----END AGE ENCRYPTED FILE-----
        - recipient: age1q522xtgjrmvr43w7um5rh02ta3yfns635680hz4m7uhw0nfqj5zqgxnz27
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSByWlpubUtMdC85SVdPTGMx
            dnhxSGREV3VSN3FUY1JzcUw1eWFYNmhHaG1vCjBiWXkvZlhNbGJUZTZ0V1BZVk91
            RllvT0tMYldreC9qZ2xUc1pINjRGRkUKLS0tIFQ0T0psQWQ2ZGNLbDdWd2hwandJ
            QVVVNHFJb0I2anlHcGZmc1lVRUQ0Z2sKvYOAkSyjsu989v7Bhmy3lZzLoYyTIUYy
            6nkjVV1BGHM6u4oDyF1WD1nP1W6I89avWZS32Z1Fc5aWxi3K8BlOLQ==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2025-09-09T19:47:11Z"
    mac: ENC[AES256_GCM,data:pPSM0M+ViVpUnDVP+U45m7ZzbZ8zw5jQKthc0rhQHhhNEDrNEzIwvR02sgfZdQAIDADUH/KbVAUNJtmqRyQBxl6WuVHg62hC+Pdv3Cd3aQf3d+Wco+dkCLNzHfo2dI+9Ocn2hV7hiZ6VImKo+MMmy5gLEsWi08McdSwZ/ICOfFw=,iv:feYLSkw95o2b2gBy2v8zkv9iqufokQMpkLxQS+WNOnI=,tag:CKU2CHaAjmBcor1JOiM7LQ==,type:str]
    encrypted_regex: ^(data|stringData|email|dnsNames|.*(H|h)osts?|hostname|username|password|url|issuer|argocdServerAdminPassword|oidc.config|commonName|literals|.*awsAccessKeyId|.*awsSecretAccessKey|.*defaultAdminPassword|apiToken|accountId|rootPassword|replicationPassword|adminPassword|root_url|client_secret|auth_url|api_url|PIHOLE_DOMAIN|TUNNEL_DNS_UPSTREAM|customDnsEntries|securityTokenKey|emailRecipients|.*provider_url|.*redirect_url|.*accesskeyEncryption|SEMAPHORE_WEB_ROOT|token|cookieEncryption|cookieHash)$
    version: 3.10.2
---
# Wasabi Credentials
# Uses the following endpoint: https://s3.eu-central-2.wasabisys.com
apiVersion: v1
kind: Secret
metadata:
    name: wasabi-secret
    namespace: longhorn
type: Opaque
data:
    AWS_ACCESS_KEY_ID: ENC[AES256_GCM,data:5fI9iiE1yL2z9/EmK2rJUqkJElSXt7XfauHDcA==,iv:0PLU25RCvSrirD98KMQOfM4VjTclWTYuIXeL/LMssak=,tag:7P1kgqpHPdtjiEEMiqR8kA==,type:str]
    AWS_SECRET_ACCESS_KEY: ENC[AES256_GCM,data:ZxUGihx746wrE5IAHUMsVt1MfId3g8SJtfaxZ1E3gT7JxwMS2KT8DnzlBxoKTHbyheS3/ZQHnzg=,iv:/WZHCTo79iJWGn4FQh+zifvjdOBloMpYAtEcnHMoAhY=,tag:VUl6r7G51l31Wlqg15jhCg==,type:str]
    AWS_ENDPOINTS: ENC[AES256_GCM,data:Cju2kTvnkEmSOVwQDKF6PT8I2D4BVUFu1QeF9boC5ZxelCcEVZxUcZyI3SgMznBM082Ckg==,iv:DSYy8B26jcGsRNv7dhpe4qbAq2sgQXSKOfozN6hJKvI=,tag:CLE30A8sjdJK4IbAPI9wFg==,type:str]
# Daily Backup
#---
#apiVersion: longhorn.io/v1beta1
#kind: RecurringJob
#metadata:
#  name: backup
#  namespace: longhorn
#spec:
#  cron: "0 4 * * *"
#  task: "backup"
#  groups:
#    - default
#  retain: 2
#  concurrency: 2
#  labels:
#    type: "full"
#    schedule: "daily"
# Trim Filesystem
sops:
    age:
        - recipient: age1d2g7tgqpfvxulsusn3m608h60h2hne7yqwv5nh5nd24z6h0hgq0skjkhw8
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBLSjgzbm9DcWRMUTBSeHJG
            RG00RXcrbnZQK0wwWHFHbEJDZFlLcS9QQzNZCkc2WTNKSEh3RFRlbXRxSzZ1cWFU
            SkhlMHN0KytBOE9tUzRITXhNTk9TS1EKLS0tIEl1VG03WEoxY2pnMDVMU1lCYjUr
            RW45azlhU3VmQlZLM2QwYUFPOGg4QW8KdvJtNTyhfRNdvNKEWy/be6JoqZTRKkMA
            d+aPJrDzVDNjG2qZdHD3SQvwMbvHuKpnvh4nU7StzUBfUhavBT74GQ==
            -----END AGE ENCRYPTED FILE-----
        - recipient: age1q522xtgjrmvr43w7um5rh02ta3yfns635680hz4m7uhw0nfqj5zqgxnz27
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSByWlpubUtMdC85SVdPTGMx
            dnhxSGREV3VSN3FUY1JzcUw1eWFYNmhHaG1vCjBiWXkvZlhNbGJUZTZ0V1BZVk91
            RllvT0tMYldreC9qZ2xUc1pINjRGRkUKLS0tIFQ0T0psQWQ2ZGNLbDdWd2hwandJ
            QVVVNHFJb0I2anlHcGZmc1lVRUQ0Z2sKvYOAkSyjsu989v7Bhmy3lZzLoYyTIUYy
            6nkjVV1BGHM6u4oDyF1WD1nP1W6I89avWZS32Z1Fc5aWxi3K8BlOLQ==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2025-09-09T19:47:11Z"
    mac: ENC[AES256_GCM,data:pPSM0M+ViVpUnDVP+U45m7ZzbZ8zw5jQKthc0rhQHhhNEDrNEzIwvR02sgfZdQAIDADUH/KbVAUNJtmqRyQBxl6WuVHg62hC+Pdv3Cd3aQf3d+Wco+dkCLNzHfo2dI+9Ocn2hV7hiZ6VImKo+MMmy5gLEsWi08McdSwZ/ICOfFw=,iv:feYLSkw95o2b2gBy2v8zkv9iqufokQMpkLxQS+WNOnI=,tag:CKU2CHaAjmBcor1JOiM7LQ==,type:str]
    encrypted_regex: ^(data|stringData|email|dnsNames|.*(H|h)osts?|hostname|username|password|url|issuer|argocdServerAdminPassword|oidc.config|commonName|literals|.*awsAccessKeyId|.*awsSecretAccessKey|.*defaultAdminPassword|apiToken|accountId|rootPassword|replicationPassword|adminPassword|root_url|client_secret|auth_url|api_url|PIHOLE_DOMAIN|TUNNEL_DNS_UPSTREAM|customDnsEntries|securityTokenKey|emailRecipients|.*provider_url|.*redirect_url|.*accesskeyEncryption|SEMAPHORE_WEB_ROOT|token|cookieEncryption|cookieHash)$
    version: 3.10.2
---
apiVersion: longhorn.io/v1beta2
kind: RecurringJob
metadata:
    name: trim-filesystem
    namespace: longhorn
spec:
    cron: 0 6 * * *
    task: filesystem-trim
    groups:
        - default
    #retain: 2
    concurrency: 1
    labels:
        type: trim
        schedule: daily
sops:
    age:
        - recipient: age1d2g7tgqpfvxulsusn3m608h60h2hne7yqwv5nh5nd24z6h0hgq0skjkhw8
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBLSjgzbm9DcWRMUTBSeHJG
            RG00RXcrbnZQK0wwWHFHbEJDZFlLcS9QQzNZCkc2WTNKSEh3RFRlbXRxSzZ1cWFU
            SkhlMHN0KytBOE9tUzRITXhNTk9TS1EKLS0tIEl1VG03WEoxY2pnMDVMU1lCYjUr
            RW45azlhU3VmQlZLM2QwYUFPOGg4QW8KdvJtNTyhfRNdvNKEWy/be6JoqZTRKkMA
            d+aPJrDzVDNjG2qZdHD3SQvwMbvHuKpnvh4nU7StzUBfUhavBT74GQ==
            -----END AGE ENCRYPTED FILE-----
        - recipient: age1q522xtgjrmvr43w7um5rh02ta3yfns635680hz4m7uhw0nfqj5zqgxnz27
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSByWlpubUtMdC85SVdPTGMx
            dnhxSGREV3VSN3FUY1JzcUw1eWFYNmhHaG1vCjBiWXkvZlhNbGJUZTZ0V1BZVk91
            RllvT0tMYldreC9qZ2xUc1pINjRGRkUKLS0tIFQ0T0psQWQ2ZGNLbDdWd2hwandJ
            QVVVNHFJb0I2anlHcGZmc1lVRUQ0Z2sKvYOAkSyjsu989v7Bhmy3lZzLoYyTIUYy
            6nkjVV1BGHM6u4oDyF1WD1nP1W6I89avWZS32Z1Fc5aWxi3K8BlOLQ==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2025-09-09T19:47:11Z"
    mac: ENC[AES256_GCM,data:pPSM0M+ViVpUnDVP+U45m7ZzbZ8zw5jQKthc0rhQHhhNEDrNEzIwvR02sgfZdQAIDADUH/KbVAUNJtmqRyQBxl6WuVHg62hC+Pdv3Cd3aQf3d+Wco+dkCLNzHfo2dI+9Ocn2hV7hiZ6VImKo+MMmy5gLEsWi08McdSwZ/ICOfFw=,iv:feYLSkw95o2b2gBy2v8zkv9iqufokQMpkLxQS+WNOnI=,tag:CKU2CHaAjmBcor1JOiM7LQ==,type:str]
    encrypted_regex: ^(data|stringData|email|dnsNames|.*(H|h)osts?|hostname|username|password|url|issuer|argocdServerAdminPassword|oidc.config|commonName|literals|.*awsAccessKeyId|.*awsSecretAccessKey|.*defaultAdminPassword|apiToken|accountId|rootPassword|replicationPassword|adminPassword|root_url|client_secret|auth_url|api_url|PIHOLE_DOMAIN|TUNNEL_DNS_UPSTREAM|customDnsEntries|securityTokenKey|emailRecipients|.*provider_url|.*redirect_url|.*accesskeyEncryption|SEMAPHORE_WEB_ROOT|token|cookieEncryption|cookieHash)$
    version: 3.10.2
---
# CSI VolumeSnapshot Associated With Longhorn Backup
kind: VolumeSnapshotClass
apiVersion: snapshot.storage.k8s.io/v1
metadata:
    name: longhorn-vsc-backup
    labels:
        velero.io/csi-volumesnapshot-class: "true"
driver: driver.longhorn.io
deletionPolicy: Delete
parameters:
    type: bak
sops:
    age:
        - recipient: age1d2g7tgqpfvxulsusn3m608h60h2hne7yqwv5nh5nd24z6h0hgq0skjkhw8
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBLSjgzbm9DcWRMUTBSeHJG
            RG00RXcrbnZQK0wwWHFHbEJDZFlLcS9QQzNZCkc2WTNKSEh3RFRlbXRxSzZ1cWFU
            SkhlMHN0KytBOE9tUzRITXhNTk9TS1EKLS0tIEl1VG03WEoxY2pnMDVMU1lCYjUr
            RW45azlhU3VmQlZLM2QwYUFPOGg4QW8KdvJtNTyhfRNdvNKEWy/be6JoqZTRKkMA
            d+aPJrDzVDNjG2qZdHD3SQvwMbvHuKpnvh4nU7StzUBfUhavBT74GQ==
            -----END AGE ENCRYPTED FILE-----
        - recipient: age1q522xtgjrmvr43w7um5rh02ta3yfns635680hz4m7uhw0nfqj5zqgxnz27
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSByWlpubUtMdC85SVdPTGMx
            dnhxSGREV3VSN3FUY1JzcUw1eWFYNmhHaG1vCjBiWXkvZlhNbGJUZTZ0V1BZVk91
            RllvT0tMYldreC9qZ2xUc1pINjRGRkUKLS0tIFQ0T0psQWQ2ZGNLbDdWd2hwandJ
            QVVVNHFJb0I2anlHcGZmc1lVRUQ0Z2sKvYOAkSyjsu989v7Bhmy3lZzLoYyTIUYy
            6nkjVV1BGHM6u4oDyF1WD1nP1W6I89avWZS32Z1Fc5aWxi3K8BlOLQ==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2025-09-09T19:47:11Z"
    mac: ENC[AES256_GCM,data:pPSM0M+ViVpUnDVP+U45m7ZzbZ8zw5jQKthc0rhQHhhNEDrNEzIwvR02sgfZdQAIDADUH/KbVAUNJtmqRyQBxl6WuVHg62hC+Pdv3Cd3aQf3d+Wco+dkCLNzHfo2dI+9Ocn2hV7hiZ6VImKo+MMmy5gLEsWi08McdSwZ/ICOfFw=,iv:feYLSkw95o2b2gBy2v8zkv9iqufokQMpkLxQS+WNOnI=,tag:CKU2CHaAjmBcor1JOiM7LQ==,type:str]
    encrypted_regex: ^(data|stringData|email|dnsNames|.*(H|h)osts?|hostname|username|password|url|issuer|argocdServerAdminPassword|oidc.config|commonName|literals|.*awsAccessKeyId|.*awsSecretAccessKey|.*defaultAdminPassword|apiToken|accountId|rootPassword|replicationPassword|adminPassword|root_url|client_secret|auth_url|api_url|PIHOLE_DOMAIN|TUNNEL_DNS_UPSTREAM|customDnsEntries|securityTokenKey|emailRecipients|.*provider_url|.*redirect_url|.*accesskeyEncryption|SEMAPHORE_WEB_ROOT|token|cookieEncryption|cookieHash)$
    version: 3.10.2
